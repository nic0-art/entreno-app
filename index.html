<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entreno App</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icon-192.png">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="theme-color" content="#00ff9c">

  <style>
    *{ box-sizing:border-box; font-family:'Segoe UI', system-ui, sans-serif; }
    body{ margin:0; background:#050a08; color:#d7ffe9; }
    .app{ max-width:420px; margin:auto; min-height:100vh; display:flex; flex-direction:column; padding:14px; }

    .header{ text-align:center; margin-bottom:12px; }
    .header h1{ margin:6px 0 2px; color:#00ff9c; }
    .header p{ margin:0; font-size:13px; opacity:.75; }

    .status-box{ display:flex; justify-content:space-between; gap:6px; margin-bottom:12px; }
    .status{ flex:1; padding:6px; border-radius:10px; text-align:center; font-size:11px; border:1px solid rgba(0,255,160,.25); }
    .green{ color:#00ff9c } .yellow{ color:#ffd000 }

    .btn{
      width:100%; padding:12px; border-radius:14px;
      background:rgba(0,0,0,.4);
      border:1px solid rgba(0,255,160,.25);
      color:#d7ffe9; margin-bottom:10px; font-weight:600;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-main{ background:rgba(0,255,160,.12); border:1px solid #00ff9c; }

    .panel{
      margin-top:12px; padding:12px; border-radius:14px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(0,255,160,.2);
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .nav{
      margin-top:auto; display:flex; justify-content:space-around;
      padding:10px 0; border-top:1px solid rgba(0,255,160,.2);
      gap:4px; flex-wrap:wrap;
    }
    .nav button{ background:none; border:none; color:#aaa; font-size:12px; padding:6px 4px; }
    .nav button.active{ color:#00ff9c; font-weight:bold; }

    .log-card{
      padding:10px; border-radius:12px;
      background:rgba(0,0,0,.30);
      border:1px solid rgba(0,255,160,.15);
      margin:10px 0;
      white-space:pre-wrap;
    }
    .log-meta{ opacity:.75; font-size:12px; }

    .row{ display:flex; gap:10px; }
    .row .btn{ width:auto; flex:1; margin-bottom:0; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field span{ font-size:12px; opacity:.8; }
    .field input, .field select{
      padding:12px; border-radius:14px;
      background:rgba(0,0,0,.4);
      border:1px solid rgba(0,255,160,.25);
      color:#d7ffe9; outline:none;
    }
    .field input:focus, .field select:focus{ border-color:#00ff9c; }

    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:flex-end; justify-content:center;
      padding:14px; z-index:9999;
    }
    .modal-backdrop.show{ display:flex; }

    .modal{
      width:100%; max-width:420px; background:#050a08;
      border:1px solid rgba(0,255,160,.25);
      border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.6);
      overflow:hidden; transform:translateY(10px);
    }

    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px 10px; border-bottom:1px solid rgba(0,255,160,.15);
    }
    .modal-title{ font-weight:800; color:#00ff9c; letter-spacing:.5px; }
    .modal-close{
      background:transparent; border:1px solid rgba(0,255,160,.25);
      color:#d7ffe9; border-radius:12px; padding:6px 10px;
      touch-action: manipulation;
    }
    .modal-body{ padding:12px; }
    .modal-actions{
      display:flex; gap:10px; padding:12px;
      border-top:1px solid rgba(0,255,160,.15);
    }
    .modal-actions .btn{ flex:1; margin:0; }

    .toast{
      position:fixed; left:50%; bottom:78px; transform:translateX(-50%);
      background:rgba(0,0,0,.85);
      border:1px solid rgba(0,255,160,.25);
      color:#d7ffe9; padding:10px 14px; border-radius:14px;
      z-index:10000; display:none;
    }

    .mini-actions{ display:flex; gap:8px; margin-top:10px; }
    .mini{
      flex:1; padding:10px; border-radius:12px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(0,255,160,.18);
      color:#d7ffe9; font-weight:600;
      touch-action: manipulation;
    }
    .mini:active{ transform: translateY(1px); }
    .mini.danger{ border-color:rgba(255,80,80,.6); }

    .kpi-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .kpi{
      padding:10px; border-radius:12px;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(0,255,160,.12);
    }
    .kpi .k{ font-size:12px; opacity:.8; }
    .kpi .v{ font-size:18px; font-weight:800; margin-top:4px; color:#00ff9c; }

    .table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; }
    .table th, .table td{
      border-bottom:1px solid rgba(0,255,160,.12);
      padding:8px 6px;
      text-align:left;
      vertical-align:top;
    }
    .table th{ color:#00ff9c; font-weight:800; }
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(0,255,160,.2);
      background:rgba(0,255,160,.08);
      font-size:11px; opacity:.95;
    }
    .muted{ opacity:.75; }

    .banner{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,255,160,.18);
      background:rgba(0,255,160,.06);
    }
    .banner .t{ color:#00ff9c; font-weight:800; margin-bottom:4px; }
    .banner .s{ font-size:12px; opacity:.85; line-height:1.3; }

    #installBtnMission, #installBtnSettings { display:none; }

    .week-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      margin-top:10px;
    }
    .day{
      padding:10px 6px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(0,255,160,.12);
      text-align:center;
      min-height:64px;
    }
    .day .d{ font-weight:800; color:#00ff9c; font-size:12px; }
    .day .n{ font-size:12px; margin-top:6px; }
    .day .m{ font-size:11px; opacity:.75; margin-top:4px; }
    .day.done{
      border-color: rgba(0,255,160,.35);
      background: rgba(0,255,160,.08);
    }
    .day.today{
      outline:2px solid rgba(255,208,0,.55);
    }
    .chip{
      display:inline-block; margin-top:6px;
      font-size:10px; padding:3px 6px;
      border-radius:999px;
      border:1px solid rgba(0,255,160,.22);
      background:rgba(0,255,160,.08);
    }

    /* CORE PRO */
    .core-tools{ display:flex; gap:8px; margin-top:8px; }
    .core-tools .mini{ flex:1; }
    .timer-read{ margin-top:6px; font-size:12px; opacity:.85; }

    /* CORE templates */
    .core-templates{
      margin-top:6px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .core-templates .chipbtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(0,255,160,.22);
      background:rgba(0,255,160,.08);
      color:#d7ffe9;
      font-size:12px;
      font-weight:700;
      touch-action: manipulation;
    }
    .core-templates .chipbtn:active{ transform: translateY(1px); }

    /* Charts */
    .chart{
      width:100%;
      height:180px;
      border-radius:12px;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(0,255,160,.12);
      margin-top:10px;
      display:block;
    }
    .chart-title{
      margin:10px 0 0;
      font-weight:800;
      color:#00ff9c;
      font-size:12px;
      letter-spacing:.3px;
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <h1>Entreno App</h1>
      <p>INTERFAZ T√ÅCTICA ¬∑ MODO OPERATIVO</p>
    </div>

    <div class="status-box">
      <div class="status green">‚óè STATUS: OK</div>
      <div class="status yellow">‚óè OBJETIVO: FUERZA MAGRA</div>
      <div class="status green">‚óè SYNC: CAPACITOR</div>
    </div>

    <div id="screen-mision" class="screen active">
      <button class="btn btn-main" onclick="iniciarMision()">INICIAR MISI√ìN</button>
      <button class="btn" onclick="abrirEntreno()">ABRIR ENTRENAMIENTO HOY</button>
      <button class="btn" onclick="registrarSerie()">REGISTRAR SERIE</button>

      <button id="installBtnMission" class="btn btn-main" onclick="instalarApp()">INSTALAR APP</button>

      <div class="banner" id="reminderBanner" style="display:none;">
        <div class="t">RECORDATORIO</div>
        <div class="s" id="reminderText"></div>
      </div>

      <div class="panel">
        <h3>√ìRDENES DEL D√çA</h3>
        <p>Antebrazo ¬∑ Gemelo ¬∑ Cuello (prioridad)</p>
        <div class="log-meta" id="phaseHint"></div>
      </div>
    </div>

    <div id="screen-entreno" class="screen">
      <div class="panel">
        <h3>ENTRENO DE HOY</h3>
        <div id="workoutBox" class="log-card"></div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">CALENDARIO (MANUAL)</h3>
          <p class="log-meta" style="margin:0 0 10px;">
            Si hoy no toca el d√≠a correcto, selecci√≥nalo aqu√≠ (solo afecta a HOY).
          </p>

          <label class="field">
            <span>D√≠a de rutina para hoy</span>
            <select id="dayOverrideSelect">
              <option value="">Autom√°tico (por d√≠a semana)</option>
              <option value="D1">D1 ¬∑ Empuje + Gemelo</option>
              <option value="D2">D2 ¬∑ Tir√≥n + Antebrazo</option>
              <option value="D3">D3 ¬∑ Pierna sin carga axial</option>
              <option value="D4">D4 ¬∑ Full suave + Cuello</option>
            </select>
          </label>

          <div class="row" style="margin-bottom:10px;">
            <button class="btn btn-main" onclick="guardarOverrideHoy()">Guardar</button>
            <button class="btn" onclick="borrarOverrideHoy()">Quitar</button>
          </div>

          <div class="log-meta" id="overrideHint"></div>
        </div>

        <label class="field" style="margin-top:10px;">
          <span>Ejercicio a registrar</span>
          <input id="quickExercise" type="text" placeholder="Ej: Prensa inclinada" />
        </label>

        <button class="btn btn-main" onclick="registrarSerieDesdeEntreno()">REGISTRAR SERIE (ENTRENO)</button>
        <button class="btn" onclick="registrarSerie()">REGISTRAR SERIE (VAC√çO)</button>
      </div>
    </div>

    <div id="screen-log" class="screen">
      <div class="panel">
        <h3>HISTORIAL DE SERIES</h3>
        <p id="logEmptyHint" class="log-meta">Sin registros a√∫n. Pulsa ‚ÄúREGISTRAR SERIE‚Äù.</p>

        <label class="field" style="margin-top:10px;">
          <span>Buscar ejercicio</span>
          <input id="logSearch" type="text" placeholder="Ej: plancha, prensa, remo..." />
        </label>

        <div class="row" style="margin:10px 0;">
          <button class="btn" style="border-color: rgba(255,80,80,.6);" onclick="borrarHistorial()">Borrar historial</button>
          <button class="btn" onclick="exportarCSV()">Exportar CSV</button>
        </div>

        <div id="logList"></div>
      </div>
    </div>

    <div id="screen-nivel" class="screen">
      <div class="panel">
        <h3>NIVEL + ESTAD√çSTICAS</h3>
        <div id="nivelBox" class="log-card"></div>
        <div class="kpi-grid" id="kpiGrid"></div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">PRs e1RM (estimado)</h3>
          <div class="log-meta">e1RM solo para series por <span class="pill">reps</span>. CORE (tiempo) no entra aqu√≠.</div>
          <div id="prBox"></div>
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Top ejercicios (√∫ltimos 28 d√≠as)</h3>
          <div class="log-meta">Barras por volumen. CORE usa: lastre √ó segundos.</div>
          <canvas id="topChart" class="chart"></canvas>
          <div id="topBox"></div>
        </div>

        <!-- NUEVO: CORE PRs -->
        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">CORE ¬∑ R√©cords + Progreso</h3>
          <div class="log-meta">Mejor tiempo y mejor tiempo con lastre por ejercicio + gr√°fico semanal (8 semanas).</div>
          <div id="corePrBox"></div>
          <div class="chart-title">Progreso CORE semanal (8 semanas)</div>
          <canvas id="coreWeeklyChart" class="chart"></canvas>
        </div>
      </div>
    </div>

    <div id="screen-stats" class="screen">
      <div class="panel">
        <h3>STATS PRO</h3>
        <div class="log-meta" id="statsMeta"></div>

        <div class="kpi-grid" id="statsKpis"></div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Prioridades (√∫ltimos 28 d√≠as)</h3>
          <div class="log-meta">Barras por series y volumen estimado (si hay lastre/peso).</div>
          <canvas id="prioChart" class="chart"></canvas>
          <div id="prioBox"></div>
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Volumen semanal (√∫ltimas 8 semanas)</h3>
          <div class="log-meta">Tonelaje: reps -> peso√óreps | CORE -> lastre√ósegundos.</div>
          <canvas id="weeklyTonChart" class="chart"></canvas>
          <div class="chart-title">Series semanales (8 semanas)</div>
          <canvas id="weeklySetsChart" class="chart"></canvas>
          <div id="weeklyBox"></div>
        </div>
      </div>
    </div>

    <div id="screen-cal" class="screen">
      <div class="panel">
        <h3>CALENDARIO</h3>
        <div class="log-meta" id="calMeta"></div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="calPrevWeek()">‚óÄ Semana</button>
          <button class="btn btn-main" onclick="calThisWeek()">Hoy</button>
          <button class="btn" onclick="calNextWeek()">Semana ‚ñ∂</button>
        </div>

        <div class="week-grid" id="weekGrid"></div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">√öltimas 4 semanas</h3>
          <div class="log-meta">Marca d√≠as con entreno. Abre LOG para ver detalles.</div>
          <div id="last4Box"></div>
        </div>
      </div>
    </div>

    <div id="screen-ajustes" class="screen">
      <div class="panel">
        <h3>AJUSTES</h3>

        <button id="installBtnSettings" class="btn btn-main" onclick="instalarApp()">INSTALAR APP</button>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Fases (perfil de entrenamiento)</h3>
          <div class="log-meta">Cada serie se guarda dentro de la fase activa.</div>

          <label class="field" style="margin-top:10px;">
            <span>Fase activa</span>
            <select id="phaseSelect"></select>
          </label>

          <div class="row" style="margin-top:8px;">
            <button class="btn btn-main" onclick="setActivePhaseFromUI()">Aplicar</button>
            <button class="btn" onclick="crearFase()">Nueva fase</button>
          </div>

          <button class="btn" style="margin-top:10px; border-color: rgba(255,80,80,.6);" onclick="borrarFaseActiva()">Borrar fase activa</button>
          <div class="log-meta" style="margin-top:10px;">*No se recomienda borrar si ya tiene datos.</div>
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Backup / Restaurar</h3>
          <div class="log-meta">Exporta todo (log + fases + ajustes) en un JSON.</div>

          <div class="row" style="margin-top:10px;">
            <button class="btn btn-main" onclick="exportarBackup()">Exportar backup</button>
            <button class="btn" onclick="clickImport()">Importar backup</button>
          </div>

          <div class="log-meta" style="margin-top:10px;">
            Importar por defecto <span class="pill">sobrescribe</span> lo actual.
          </div>

          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">PWA / Actualizaciones</h3>
          <div class="log-meta" id="pwaStatus">Estado: comprobando‚Ä¶</div>

          <div class="row" style="margin-top:10px;">
            <button class="btn btn-main" onclick="actualizarApp()">Actualizar app (cache)</button>
            <button class="btn" onclick="verVersion()">Ver versi√≥n</button>
          </div>

          <div class="log-meta" style="margin-top:10px;">
            Si no ves cambios, cierra la app (multitarea) y abre de nuevo.
          </div>
        </div>

        <button class="btn" style="margin-top:10px;" onclick="resetearMision()">Resetear misi√≥n</button>
      </div>
    </div>

    <div class="nav">
      <button class="active" data-screen="mision">MISI√ìN</button>
      <button data-screen="entreno">ENTRENO</button>
      <button data-screen="log">LOG</button>
      <button data-screen="nivel">NIVEL</button>
      <button data-screen="stats">STATS</button>
      <button data-screen="cal">CAL</button>
      <button data-screen="ajustes">AJUSTES</button>
    </div>
  </div>

  <!-- ===== MODAL (SERIE + CORE PRO) ===== -->
  <div id="modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Registrar serie">
      <div class="modal-head">
        <div id="modalTitle" class="modal-title">REGISTRAR SERIE</div>
        <button class="modal-close" id="modalClose" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="row">
          <label class="field" style="flex:1;">
            <span>Modo</span>
            <select id="mMode">
              <option value="reps">Reps</option>
              <option value="time">CORE (Tiempo)</option>
            </select>
          </label>
          <label class="field" style="flex:1;">
            <span>Serie n¬∫</span>
            <input id="mSerie" type="number" inputmode="numeric" placeholder="1" min="1" step="1" />
          </label>
        </div>

        <!-- NUEVO: plantillas CORE -->
        <div class="log-meta">Plantillas CORE (toca una para rellenar r√°pido)</div>
        <div class="core-templates" id="coreTemplates"></div>

        <label class="field" style="margin-top:10px;">
          <span>Ejercicio</span>
          <input id="mEjercicio" type="text" placeholder="Ej: Plancha lastrada" />
        </label>

        <div class="row">
          <label class="field" style="flex:1;">
            <span>Peso (kg) / lastre</span>
            <input id="mPeso" type="number" inputmode="decimal" placeholder="0" step="0.5" />
          </label>

          <label class="field" style="flex:1;" id="repsField">
            <span>Reps</span>
            <input id="mReps" type="number" inputmode="numeric" placeholder="0" min="0" step="1" />
          </label>

          <label class="field" style="flex:1; display:none;" id="timeField">
            <span>Tiempo (seg)</span>
            <input id="mSeconds" type="number" inputmode="numeric" placeholder="30" min="0" step="5" />
            <div class="timer-read" id="timerRead"></div>
            <div class="core-tools">
              <button type="button" class="mini" id="tMinus">-10s</button>
              <button type="button" class="mini" id="tStartStop">Start</button>
              <button type="button" class="mini" id="tPlus">+10s</button>
            </div>
          </label>
        </div>

        <label class="field">
          <span>RPE (opcional)</span>
          <input id="mRpe" type="number" inputmode="decimal" placeholder="8" step="0.5" min="0" max="10" />
        </label>
      </div>

      <div class="modal-actions">
        <button class="btn" id="modalCancel">Cancelar</button>
        <button class="btn btn-main" id="modalSave">Guardar</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /* =========================
       VERSIONES
    ========================= */
    const APP_VERSION = "Entreno-PWA 1.5.0";
    const CACHE_VERSION = "bilbo-pro-v6"; // debe coincidir con sw.js

    /* =========================
       INSTALL
    ========================= */
    let deferredInstallPrompt = null;

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredInstallPrompt = e;

      const b1 = document.getElementById("installBtnMission");
      const b2 = document.getElementById("installBtnSettings");
      if(b1) b1.style.display = "block";
      if(b2) b2.style.display = "block";

      showToast("üì≤ App lista para instalar");
    });

    window.addEventListener("appinstalled", () => {
      deferredInstallPrompt = null;
      const b1 = document.getElementById("installBtnMission");
      const b2 = document.getElementById("installBtnSettings");
      if(b1) b1.style.display = "none";
      if(b2) b2.style.display = "none";
      showToast("‚úÖ App instalada");
    });

    async function instalarApp(){
      if(!deferredInstallPrompt){
        showToast("‚ÑπÔ∏è Men√∫ ‚ãÆ ‚Üí Instalar / A√±adir a pantalla.");
        return;
      }
      deferredInstallPrompt.prompt();
      const res = await deferredInstallPrompt.userChoice;
      deferredInstallPrompt = null;

      if(res && res.outcome === "accepted") showToast("‚úÖ Instalaci√≥n aceptada");
      else showToast("‚ùå Instalaci√≥n cancelada");
    }

    /* =========================
       HELPERS
    ========================= */
    function showToast(msg){
      const t = document.getElementById("toast");
      if(!t) return;
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(()=> t.style.display="none", 1400);
    }
    function uid(){
      try { return crypto.randomUUID(); }
      catch(e){ return String(Date.now()) + "_" + Math.random().toString(16).slice(2); }
    }
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function toNum(v){
      const n = Number(String(v ?? "").replace(",", "."));
      return Number.isFinite(n) ? n : NaN;
    }
    function toIntSafe(v, fallback=0){
      const n = parseFloat(String(v ?? "").replace(",", "."));
      return Number.isFinite(n) ? Math.round(n) : fallback;
    }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function startOfWeekISO(date = new Date()){
      const d = new Date(date);
      const day = (d.getDay() + 6) % 7;
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() - day);
      return d;
    }
    function addDays(date, days){
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }
    function iso(d){ return d.toISOString().slice(0,10); }
    function fmtShort(isoDate){
      const [y,m,d] = isoDate.split("-");
      return `${d}/${m}`;
    }
    function fmtTime(seconds){
      const s = Math.max(0, toIntSafe(seconds, 0));
      const mm = Math.floor(s/60);
      const ss = s % 60;
      return mm > 0 ? `${mm}:${String(ss).padStart(2,"0")}` : `${ss}s`;
    }
    function norm(s){ return String(s||"").toLowerCase().trim(); }

    /* =========================
       NAV
    ========================= */
    const screens = {
      mision: document.getElementById("screen-mision"),
      entreno: document.getElementById("screen-entreno"),
      log: document.getElementById("screen-log"),
      nivel: document.getElementById("screen-nivel"),
      stats: document.getElementById("screen-stats"),
      cal: document.getElementById("screen-cal"),
      ajustes: document.getElementById("screen-ajustes")
    };

    function showScreen(key){
      Object.values(screens).forEach(s=>s.classList.remove("active"));
      if(screens[key]) screens[key].classList.add("active");
    }
    function setActiveNav(key){
      document.querySelectorAll(".nav button").forEach(b=>{
        b.classList.toggle("active", b.getAttribute("data-screen") === key);
      });
    }

    document.querySelectorAll(".nav button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.getAttribute("data-screen");
        setActiveNav(key);
        showScreen(key);

        if(key==="log") renderLog();
        if(key==="nivel") renderNivel();
        if(key==="stats") renderStats();
        if(key==="cal") renderCalendar();
        if(key==="entreno") renderWorkoutToday();
        if(key==="ajustes"){ refreshPwaStatus(); renderPhasesUI(); }
      });
    });

    /* =========================
       PLAN
    ========================= */
    const splitDays = [
      { key:"D1", name:"D1 ¬∑ Empuje + Gemelo", focus:"Pecho/Hombro/Tr√≠ceps + Gemelo (prioridad)" },
      { key:"D2", name:"D2 ¬∑ Tir√≥n + Antebrazo", focus:"Espalda sin lumbar + Antebrazo (prioridad)" },
      { key:"D3", name:"D3 ¬∑ Pierna sin carga axial", focus:"Prensa + Femoral + Hip Thrust + Gemelo (prioridad)" },
      { key:"D4", name:"D4 ¬∑ Full suave + Cuello", focus:"Full suave + Core + Cuello (prioridad)" }
    ];

    const blocks = {
      D1: [
        "EJ PRINCIPAL: Press pecho m√°quina/mancuernas ¬∑ 4√ó6‚Äì8",
        "Accesorio: Elevaciones laterales ¬∑ 3√ó10‚Äì12",
        "Accesorio: Fondos/Tr√≠ceps polea ¬∑ 3√ó8‚Äì12",
        "PRIORIDAD: Gemelo sentado ¬∑ 5√ó12‚Äì20"
      ],
      D2: [
        "EJ PRINCIPAL: Remo con pecho apoyado ¬∑ 4√ó6‚Äì8 (sin lumbar)",
        "Accesorio: Jal√≥n al pecho ¬∑ 3√ó8‚Äì10",
        "Accesorio: Curl b√≠ceps ¬∑ 3√ó10‚Äì12",
        "PRIORIDAD: Antebrazo (curl mu√±eca + reverse curl) ¬∑ 5√ó12‚Äì20"
      ],
      D3: [
        "EJ PRINCIPAL: Prensa inclinada ¬∑ 5√ó8‚Äì12",
        "Accesorio: Curl femoral ¬∑ 4√ó10‚Äì12",
        "Sustituto PM: Hip Thrust ¬∑ 4√ó8‚Äì12",
        "PRIORIDAD: Gemelo de pie ¬∑ 5√ó12‚Äì20",
        "Opcional: Step-ups / Hack squat m√°quina ¬∑ 2‚Äì3√ó8‚Äì12"
      ],
      D4: [
        "Bilbo suave: Press inclinado ligero ¬∑ 3√ó8‚Äì10",
        "Accesorio: Remo ligero ¬∑ 3√ó8‚Äì10",
        "Core: plancha/antirotaci√≥n ¬∑ 4√ó30‚Äì45s",
        "PRIORIDAD: Cuello (flex/ext/lat) ¬∑ 5√ó15‚Äì20"
      ]
    };

    function dayIndexFromWeek(){
      const dow = new Date().getDay();
      const map = {1:0,2:1,3:2,4:3,5:4,6:5,0:6};
      return map[dow];
    }

    /* Override manual hoy */
    const LS_DAY_OVERRIDE = "bilbo_day_override_v1";
    function getDayOverrideForToday(){
      try{
        const obj = JSON.parse(localStorage.getItem(LS_DAY_OVERRIDE) || "null");
        if(obj && obj.date === todayISO() && obj.key) return obj.key;
      }catch(e){}
      return "";
    }
    function setDayOverrideForToday(key){
      localStorage.setItem(LS_DAY_OVERRIDE, JSON.stringify({ date: todayISO(), key }));
    }
    function clearDayOverride(){ localStorage.removeItem(LS_DAY_OVERRIDE); }

    function workoutToday(){
      const overrideKey = getDayOverrideForToday();
      if(overrideKey){
        const day = splitDays.find(d=>d.key===overrideKey) || splitDays[0];
        return { ...day, date: todayISO(), override:true };
      }
      const idx = dayIndexFromWeek();
      const plan = ["D1","D2","D3","D4","D4","D4","D4"];
      const key = plan[idx];
      const day = splitDays.find(d=>d.key===key) || splitDays[0];
      return { ...day, date: todayISO(), override:false };
    }

    function syncOverrideUI(){
      const sel = document.getElementById("dayOverrideSelect");
      const hint = document.getElementById("overrideHint");
      if(!sel || !hint) return;

      const ov = getDayOverrideForToday();
      sel.value = ov || "";
      hint.textContent = ov ? `Override activo hoy: ${ov}. (Solo hoy)` : `Modo autom√°tico activo (por d√≠a de semana).`;
    }

    function guardarOverrideHoy(){
      const sel = document.getElementById("dayOverrideSelect");
      const val = sel ? sel.value : "";
      if(!val){ showToast("‚ö†Ô∏è Selecciona D1‚ÄìD4 o usa Quitar"); return; }
      setDayOverrideForToday(val);
      syncOverrideUI();
      renderWorkoutToday();
      showToast("‚úÖ D√≠a guardado para hoy");
    }

    function borrarOverrideHoy(){
      clearDayOverride();
      syncOverrideUI();
      renderWorkoutToday();
      showToast("‚úÖ Override quitado");
    }

    function renderWorkoutToday(){
      const w = workoutToday();
      const box = document.getElementById("workoutBox");
      if(box){
        const text = (blocks[w.key] || []).map(x=>`‚Ä¢ ${x}`).join("\n");
        const flag = w.override ? " (MANUAL)" : " (AUTO)";
        box.textContent = `${w.name}${flag}\n${w.focus}\n\nüìÖ ${w.date}\n\n${text}`;
      }

      const qe = document.getElementById("quickExercise");
      if(qe && !qe.value){
        const defaults = { D1:"Press pecho m√°quina/mancuernas", D2:"Remo con pecho apoyado", D3:"Prensa inclinada", D4:"Plancha (core)" };
        qe.value = defaults[w.key] || "";
      }
      syncOverrideUI();
      renderReminder();
      renderPhaseHint();
    }

    function abrirEntreno(){
      setActiveNav("entreno");
      showScreen("entreno");
      renderWorkoutToday();
    }

    /* =========================
       FASES
    ========================= */
    const LS_PHASES = "bilbo_phases_v1";
    const LS_ACTIVE_PHASE = "bilbo_active_phase_v1";

    function defaultPhases(){ return [{ id:"phase_default", name:"Fase principal", createdAt: Date.now() }]; }
    function readPhases(){
      try{
        const arr = JSON.parse(localStorage.getItem(LS_PHASES) || "null");
        if(Array.isArray(arr) && arr.length) return arr;
      }catch(e){}
      return defaultPhases();
    }
    function writePhases(arr){ localStorage.setItem(LS_PHASES, JSON.stringify(arr)); }
    function getActivePhaseId(){
      const id = localStorage.getItem(LS_ACTIVE_PHASE);
      const phases = readPhases();
      if(id && phases.some(p=>p.id===id)) return id;
      const fallback = phases[0].id;
      localStorage.setItem(LS_ACTIVE_PHASE, fallback);
      return fallback;
    }
    function setActivePhase(id){ localStorage.setItem(LS_ACTIVE_PHASE, id); }
    function getActivePhase(){
      const phases = readPhases();
      const id = getActivePhaseId();
      return phases.find(p=>p.id===id) || phases[0];
    }

    function renderPhasesUI(){
      const sel = document.getElementById("phaseSelect");
      if(!sel) return;
      const phases = readPhases();
      const activeId = getActivePhaseId();
      sel.innerHTML = phases.map(p => `<option value="${p.id}">${p.name}</option>`).join("");
      sel.value = activeId;
      renderPhaseHint();
    }
    function setActivePhaseFromUI(){
      const sel = document.getElementById("phaseSelect");
      if(!sel) return;
      setActivePhase(sel.value);
      showToast("‚úÖ Fase activa cambiada");
      renderPhaseHint();
      renderReminder();
      renderLog(); renderNivel(); renderStats(); renderCalendar();
    }
    function crearFase(){
      const name = prompt("Nombre de la nueva fase:", "Fase nueva");
      if(!name) return;
      const phases = readPhases();
      const id = "phase_" + uid();
      phases.push({ id, name: name.trim(), createdAt: Date.now() });
      writePhases(phases);
      setActivePhase(id);
      renderPhasesUI();
      showToast("‚úÖ Fase creada y activada");
    }
    function borrarFaseActiva(){
      const active = getActivePhase();
      if(active.id === "phase_default"){ showToast("‚ö†Ô∏è No puedes borrar la fase principal"); return; }
      if(!confirm(`¬øBorrar fase "${active.name}"?`)) return;
      const phases = readPhases().filter(p=>p.id !== active.id);
      writePhases(phases);
      setActivePhase(phases[0].id);
      renderPhasesUI();
      showToast("üóëÔ∏è Fase borrada");
    }
    function renderPhaseHint(){
      const el = document.getElementById("phaseHint");
      if(!el) return;
      el.textContent = `Fase activa: ${getActivePhase().name}`;
    }

    /* =========================
       LOG (v3)
    ========================= */
    const LS_LOG_V1 = "bilbo_log_v1";
    const LS_LOG = "bilbo_log_v3";
    const LS_MIGRATED = "bilbo_log_migrated_to_v3";
    const LS_MISSION = "bilbo_mission_v1";

    function safeParse(key){
      try { return JSON.parse(localStorage.getItem(key) || "[]"); }
      catch(e){ return []; }
    }
    function readLogAll(){
      const arr = safeParse(LS_LOG);
      return Array.isArray(arr) ? arr : [];
    }
    function writeLogAll(arr){ localStorage.setItem(LS_LOG, JSON.stringify(arr)); }
    function readLog(){
      const all = readLogAll();
      const pid = getActivePhaseId();
      return all.filter(x => (x.phaseId || "phase_default") === pid);
    }
    function writeLogForActivePhase(filteredArr){
      const pid = getActivePhaseId();
      const all = readLogAll().filter(x => (x.phaseId || "phase_default") !== pid);
      const withPhase = filteredArr.map(x => ({ ...x, phaseId: pid }));
      writeLogAll([...withPhase, ...all].sort((a,b)=> (b.ts||0)-(a.ts||0)));
    }

    function migrateLogIfNeeded(){
      if(localStorage.getItem(LS_MIGRATED) === "1") return;

      const v3 = safeParse(LS_LOG);
      if(Array.isArray(v3) && v3.length > 0){
        localStorage.setItem(LS_MIGRATED, "1");
        return;
      }

      const candidates = ["bilbo_log_v2", LS_LOG_V1];
      let source = [];
      for(const k of candidates){
        const arr = safeParse(k);
        if(Array.isArray(arr) && arr.length){ source = arr; break; }
      }

      if(!Array.isArray(source) || source.length === 0){
        localStorage.setItem(LS_MIGRATED, "1");
        return;
      }

      const phases = readPhases();
      writePhases(phases);
      setActivePhase(getActivePhaseId());

      const converted = source.map((it) => ({
        id: it.id || uid(),
        ts: it.ts ? Number(it.ts) : Date.now(),
        date: it.date || "",
        day: it.day || "",
        dayName: it.dayName || "",
        ejercicio: it.ejercicio || "",
        peso: it.peso || "",
        reps: it.reps || "",
        seconds: it.seconds || "",
        mode: it.mode || (it.seconds ? "time" : "reps"),
        serie: it.serie || "",
        rpe: it.rpe || "",
        phaseId: it.phaseId || "phase_default"
      }));

      writeLogAll(converted);
      localStorage.setItem(LS_MIGRATED, "1");
      showToast(`‚úÖ Migrado historial: ${converted.length} series`);
    }

    /* =========================
       MODAL + CORE PRO
    ========================= */
    let EDITING_ID = null;
    let TIMER = { running:false, interval:null, endTs:0 };

    const CORE_TEMPLATES = [
      { label:"Plancha", value:"Plancha (core)" },
      { label:"Hollow", value:"Hollow hold" },
      { label:"Side plank", value:"Plancha lateral" },
      { label:"Pallof", value:"Pallof press" },
      { label:"Anti-rotaci√≥n", value:"Anti-rotaci√≥n (cable/banda)" }
    ];

    function stopTimer(){
      TIMER.running = false;
      if(TIMER.interval) clearInterval(TIMER.interval);
      TIMER.interval = null;
      TIMER.endTs = 0;
      const btn = document.getElementById("tStartStop");
      if(btn) btn.textContent = "Start";
    }

    function updateTimerRead(){
      const read = document.getElementById("timerRead");
      const secInput = document.getElementById("mSeconds");
      if(!read || !secInput) return;
      const s = toIntSafe(secInput.value, 0);
      read.textContent = s > 0 ? `Tiempo: ${fmtTime(s)}` : "";
    }

    function setModeUI(mode){
      const repsField = document.getElementById("repsField");
      const timeField = document.getElementById("timeField");
      if(!repsField || !timeField) return;

      if(mode === "time"){
        repsField.style.display = "none";
        timeField.style.display = "block";
      }else{
        timeField.style.display = "none";
        repsField.style.display = "block";
      }
      stopTimer();
      updateTimerRead();
    }

    function applyCoreTemplate(text){
      const modeSel = document.getElementById("mMode");
      const ex = document.getElementById("mEjercicio");
      if(modeSel) modeSel.value = "time";
      setModeUI("time");
      if(ex) ex.value = text;
      showToast("‚úÖ Plantilla CORE aplicada");
    }

    function renderCoreTemplates(){
      const box = document.getElementById("coreTemplates");
      if(!box) return;
      box.innerHTML = CORE_TEMPLATES.map(t =>
        `<button type="button" class="chipbtn" data-core="${t.value}">${t.label}</button>`
      ).join("");

      box.querySelectorAll("button[data-core]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const v = btn.getAttribute("data-core") || "";
          applyCoreTemplate(v);
        });
      });
    }

    function abrirModalSerie(ejercicio = "", prefill = null){
      const modal = document.getElementById("modal");
      const title = document.getElementById("modalTitle");
      const modeSel = document.getElementById("mMode");

      if(prefill){
        EDITING_ID = prefill.id || null;
        title.textContent = "EDITAR SERIE";

        modeSel.value = prefill.mode || (prefill.seconds ? "time" : "reps");
        document.getElementById("mSerie").value = prefill.serie || "1";
        document.getElementById("mEjercicio").value = prefill.ejercicio || "";
        document.getElementById("mPeso").value = prefill.peso || "";
        document.getElementById("mReps").value = (modeSel.value==="reps") ? (prefill.reps || "") : "";
        document.getElementById("mSeconds").value = prefill.seconds || (modeSel.value==="time" ? (prefill.reps || "30") : "30");
        document.getElementById("mRpe").value = prefill.rpe || "";
      }else{
        EDITING_ID = null;
        title.textContent = "REGISTRAR SERIE";
        const det = String(ejercicio||"").toLowerCase();
        const autoMode =
          (det.includes("plancha") || det.includes("core") || det.includes("hold") || det.includes("isom√©tr") || det.includes("isometr") ||
           det.includes("pallof") || det.includes("anti-rot")) ? "time" : "reps";

        modeSel.value = autoMode;
        document.getElementById("mSerie").value = "1";
        document.getElementById("mEjercicio").value = ejercicio || "";
        document.getElementById("mPeso").value = "";
        document.getElementById("mReps").value = "";
        document.getElementById("mSeconds").value = "30";
        document.getElementById("mRpe").value = "";
      }

      setModeUI(modeSel.value);

      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      setTimeout(()=> document.getElementById("mEjercicio").focus(), 50);
    }

    function cerrarModalSerie(){
      stopTimer();
      const modal = document.getElementById("modal");
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    function bindModal(){
      const close = document.getElementById("modalClose");
      const cancel = document.getElementById("modalCancel");
      const save = document.getElementById("modalSave");
      const backdrop = document.getElementById("modal");

      const modeSel = document.getElementById("mMode");
      const secInput = document.getElementById("mSeconds");
      const minus = document.getElementById("tMinus");
      const plus = document.getElementById("tPlus");
      const startStop = document.getElementById("tStartStop");

      close.onclick = cerrarModalSerie;
      cancel.onclick = cerrarModalSerie;

      backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) cerrarModalSerie(); });
      document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && backdrop.classList.contains("show")) cerrarModalSerie(); });

      modeSel.addEventListener("change", ()=> setModeUI(modeSel.value));
      secInput.addEventListener("input", ()=> { stopTimer(); updateTimerRead(); });

      minus.addEventListener("click", ()=>{
        const cur = toIntSafe(secInput.value, 0);
        secInput.value = Math.max(0, cur - 10);
        stopTimer(); updateTimerRead();
      });
      plus.addEventListener("click", ()=>{
        const cur = toIntSafe(secInput.value, 0);
        secInput.value = Math.max(0, cur + 10);
        stopTimer(); updateTimerRead();
      });

      startStop.addEventListener("click", ()=>{
        if(modeSel.value !== "time") return;

        const total = toIntSafe(secInput.value, 0);
        if(total <= 0){ showToast("‚ö†Ô∏è Pon un tiempo > 0"); return; }

        if(!TIMER.running){
          TIMER.running = true;
          TIMER.endTs = Date.now() + (total * 1000);
          startStop.textContent = "Stop";

          TIMER.interval = setInterval(()=>{
            const left = Math.max(0, Math.ceil((TIMER.endTs - Date.now())/1000));
            secInput.value = left;
            updateTimerRead();
            if(left <= 0){
              stopTimer();
              showToast("‚è±Ô∏è Tiempo completado");
              try { navigator.vibrate && navigator.vibrate([80,50,80]); } catch(e){}
            }
          }, 250);
        }else{
          stopTimer();
          updateTimerRead();
        }
      });

      save.onclick = ()=>{
        const mode = modeSel.value;

        const ejercicio = document.getElementById("mEjercicio").value.trim();
        const peso = document.getElementById("mPeso").value;
        const serie = document.getElementById("mSerie").value;
        const rpe = document.getElementById("mRpe").value;

        const repsVal = document.getElementById("mReps").value;
        const secVal = document.getElementById("mSeconds").value;

        if(!ejercicio || !serie){ showToast("‚ö†Ô∏è Completa: ejercicio y serie"); return; }

        let repsToStore = "";
        let secondsToStore = "";

        if(mode === "reps"){
          if(!repsVal){ showToast("‚ö†Ô∏è Indica reps"); return; }
          repsToStore = String(repsVal);
          secondsToStore = "";
        }else{
          const s = toIntSafe(secVal, 0);
          if(s <= 0){ showToast("‚ö†Ô∏è Indica tiempo (seg)"); return; }
          secondsToStore = String(s);
          // compatibilidad: reps = seconds
          repsToStore = String(s);
        }

        const w = workoutToday();
        const pid = getActivePhaseId();
        const log = readLog();

        if(EDITING_ID){
          const idx = log.findIndex(x => x.id === EDITING_ID);
          if(idx >= 0){
            const prev = log[idx];
            log[idx] = {
              ...prev,
              ejercicio,
              peso: peso || "",
              reps: repsToStore || "",
              seconds: secondsToStore || "",
              mode,
              serie: serie || "",
              rpe: rpe || ""
            };
            writeLogForActivePhase(log);
            cerrarModalSerie();
            renderLog(); renderNivel(); renderStats(); renderCalendar();
            showToast("‚úÖ Serie editada");
            return;
          }
        }

        const item = {
          id: uid(),
          ts: Date.now(),
          date: w.date,
          day: w.key,
          dayName: w.name,
          ejercicio,
          peso: peso || "",
          reps: repsToStore || "",
          seconds: secondsToStore || "",
          mode,
          serie: serie || "",
          rpe: rpe || "",
          phaseId: pid
        };

        log.unshift(item);
        writeLogForActivePhase(log);

        cerrarModalSerie();
        renderLog(); renderNivel(); renderStats(); renderCalendar();
        showToast("‚úÖ Serie guardada");
      };
    }

    function registrarSerie(){ abrirModalSerie(""); }
    function registrarSerieDesdeEntreno(){
      const ex = (document.getElementById("quickExercise")?.value || "").trim();
      abrirModalSerie(ex);
    }

    /* =========================
       LOG UI + SEARCH
    ========================= */
    function renderLog(){
      const list = document.getElementById("logList");
      const hint = document.getElementById("logEmptyHint");
      if(!list) return;

      const q = norm(document.getElementById("logSearch")?.value || "");
      let log = readLog();

      if(q){
        log = log.filter(it => norm(it.ejercicio).includes(q));
      }

      list.innerHTML = "";
      if(hint) hint.style.display = log.length ? "none" : "block";

      log.slice(0,250).forEach(it=>{
        const div = document.createElement("div");
        div.className = "log-card";

        const time = new Date(it.ts).toLocaleString();
        const line1 = `${it.dayName || it.day || ""}`;
        const line2 = `üìÖ ${it.date || ""} ¬∑ ${time}`;
        const line3 = `${it.ejercicio || ""}`;

        const isTime = (it.mode === "time") || (!!it.seconds);
        const corePart = isTime ? ` ¬∑ ${fmtTime(it.seconds || it.reps)}` : ` ¬∑ ${it.reps || "-"} reps`;
        const line4 =
          `Serie ${it.serie || "-"} ¬∑ ${it.peso || "-"} kg` +
          corePart +
          (it.rpe ? ` ¬∑ RPE ${it.rpe}` : "");

        div.textContent = `${line1}\n${line2}\n${line3}\n${line4}`;

        const actions = document.createElement("div");
        actions.className = "mini-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "mini";
        editBtn.textContent = "Editar ‚úèÔ∏è";
        editBtn.onclick = ()=> abrirModalSerie("", it);

        const delBtn = document.createElement("button");
        delBtn.className = "mini danger";
        delBtn.textContent = "Borrar üóëÔ∏è";
        delBtn.onclick = ()=>{
          if(!confirm("¬øBorrar esta serie?")) return;
          borrarSerie(it.id);
        };

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        div.appendChild(actions);

        list.appendChild(div);
      });
    }

    function borrarSerie(id){
      const log = readLog();
      writeLogForActivePhase(log.filter(x => x.id !== id));
      renderLog(); renderNivel(); renderStats(); renderCalendar();
      showToast("üóëÔ∏è Serie borrada");
    }

    function borrarHistorial(){
      if(!confirm("¬øBorrar TODO el historial de la fase activa?")) return;
      writeLogForActivePhase([]);
      renderLog(); renderNivel(); renderStats(); renderCalendar();
      showToast("üóëÔ∏è Historial borrado (fase)");
    }

    /* =========================
       CSV
    ========================= */
    function csvEscape(v){
      const s = String(v ?? "");
      if (/[,"\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
      return s;
    }

    function exportarCSV(){
      const log = readLog();
      const header = ["fecha","dia_key","dia_nombre","ejercicio","serie","peso_kg","reps","seconds","mode","rpe","timestamp","id","fase"];
      const phaseName = getActivePhase().name;

      const rows = log.map(it => ([
        it.date || "",
        it.day || "",
        it.dayName || "",
        it.ejercicio || "",
        it.serie || "",
        it.peso || "",
        it.reps || "",
        it.seconds || "",
        it.mode || "",
        it.rpe || "",
        it.ts ? new Date(it.ts).toISOString() : "",
        it.id || "",
        phaseName
      ]));

      const csv = header.join(",") + "\n" + rows.map(r => r.map(csvEscape).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `entreno_log_${phaseName.replace(/\s+/g,"_")}_${todayISO()}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      showToast("‚úÖ CSV descargado");
    }

    /* =========================
       STATS ENGINE
    ========================= */
    function e1RM_Epley(weight, reps){
      const w = toNum(weight);
      const r = Math.floor(toNum(reps));
      if(!Number.isFinite(w) || !Number.isFinite(r) || w <= 0 || r <= 0) return NaN;
      const rr = clamp(r, 1, 30);
      return w * (1 + (rr / 30));
    }

    function withinLastDays(ts, days){
      const ms = days * 24 * 60 * 60 * 1000;
      return (Date.now() - ts) <= ms;
    }

    function fmtKg(n){
      if(!Number.isFinite(n)) return "-";
      const v = Math.round(n * 10) / 10;
      return `${v}`;
    }

    function classifyPriority(ex){
      const e = norm(ex);
      if(e.includes("gemelo") || e.includes("calf")) return "gemelos";
      if(e.includes("antebra") || e.includes("mu√±eca") || e.includes("muneca") || e.includes("forearm") || e.includes("reverse curl")) return "antebrazos";
      if(e.includes("cuello") || e.includes("neck")) return "cuello";
      return null;
    }

    function weekKeyFromISODate(isoDate){
      const d = new Date(isoDate + "T00:00:00");
      const monday = startOfWeekISO(d);
      const y = monday.getFullYear();
      const jan4 = new Date(y,0,4);
      const jan4Mon = startOfWeekISO(jan4);
      const diff = (monday - jan4Mon) / (7*24*60*60*1000);
      const wk = Math.floor(diff) + 1;
      return `${y}-W${String(wk).padStart(2,"0")}`;
    }

    function isCore(it){
      const e = norm(it.ejercicio);
      return (it.mode === "time") || !!it.seconds ||
        e.includes("plancha") || e.includes("hollow") || e.includes("pallof") || e.includes("anti-rot") || e.includes("anti rot");
    }

    function seriesVolume(it){
      const w = toNum(it.peso);
      const r = toNum(it.reps);
      const time = (it.mode === "time") || !!it.seconds;

      if(!Number.isFinite(w) || w <= 0 || !Number.isFinite(r) || r <= 0){
        return { sets:1, vol:0 };
      }
      // reps: w*r ; core time: w*seconds (seconds guardado en reps)
      return { sets:1, vol: w * r };
    }

    function summarize(log){
      const sessions = new Set(log.map(x => x.date).filter(Boolean));
      let vol7 = 0, vol28 = 0;
      let series7 = 0, series28 = 0;

      const byExercise28 = new Map();
      const prByExercise = new Map();

      for(const s of log){
        const ts = Number(s.ts) || 0;
        const is28 = ts && withinLastDays(ts, 28);
        const is7  = ts && withinLastDays(ts, 7);

        if(is28) series28++;
        if(is7) series7++;

        const sv = seriesVolume(s);
        if(is28) vol28 += sv.vol;
        if(is7)  vol7 += sv.vol;

        if(is28){
          const ex = (s.ejercicio || "Sin nombre").trim();
          const cur = byExercise28.get(ex) || { sets:0, vol:0 };
          cur.sets += 1;
          cur.vol += sv.vol;
          byExercise28.set(ex, cur);
        }

        // PRs: SOLO reps (no core/time)
        if(isCore(s)) continue;

        const w = toNum(s.peso);
        const r = toNum(s.reps);
        if(Number.isFinite(w) && Number.isFinite(r) && w > 0 && r > 0){
          const exKey = (s.ejercicio || "Sin nombre").trim();
          const e1 = e1RM_Epley(w, r);
          if(Number.isFinite(e1)){
            const prev = prByExercise.get(exKey);
            if(!prev || e1 > prev.e1rm){
              prByExercise.set(exKey, { e1rm: e1, w, r, date: s.date || "", ts });
            }
          }
        }
      }

      const top28 = [...byExercise28.entries()]
        .map(([ex, v]) => ({ ex, sets: v.sets, vol: v.vol }))
        .sort((a,b) => (b.vol - a.vol) || (b.sets - a.sets))
        .slice(0, 10);

      const prs = [...prByExercise.entries()]
        .map(([ex, v]) => ({ ex, ...v }))
        .sort((a,b) => b.e1rm - a.e1rm)
        .slice(0, 12);

      return { sessionsCount: sessions.size, series7, series28, vol7, vol28, top28, prs };
    }

    /* =========================
       CHARTS (Canvas)
    ========================= */
    function fitCanvas(canvas){
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const rect = canvas.getBoundingClientRect();
      const w = Math.floor(rect.width);
      const h = Math.floor(rect.height);
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return { ctx, w, h };
    }

    function clearChart(ctx, w, h){
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = "rgba(0,0,0,0)";
      ctx.fillRect(0,0,w,h);
    }

    function drawBarChart(canvas, labels, values, options = {}){
      if(!canvas) return;
      const { ctx, w, h } = fitCanvas(canvas);
      clearChart(ctx, w, h);

      const padL = 10, padR = 10, padT = 12, padB = 22;
      const innerW = w - padL - padR;
      const innerH = h - padT - padB;

      const maxV = Math.max(1, ...values.map(v => Number.isFinite(v) ? v : 0));
      const n = labels.length || 1;
      const gap = 6;
      const barW = Math.max(8, Math.floor((innerW - gap*(n-1)) / n));

      ctx.strokeStyle = "rgba(0,255,160,.12)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padL, padT + innerH);
      ctx.lineTo(padL + innerW, padT + innerH);
      ctx.stroke();

      for(let i=0;i<n;i++){
        const v = Number.isFinite(values[i]) ? values[i] : 0;
        const x = padL + i*(barW + gap);
        const bh = Math.round((v / maxV) * innerH);
        const y = padT + (innerH - bh);

        ctx.fillStyle = "rgba(0,255,156,.55)";
        ctx.fillRect(x, y, barW, bh);

        ctx.fillStyle = "rgba(215,255,233,.85)";
        ctx.font = "10px Segoe UI, system-ui, sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(String(labels[i]).slice(0,7), x + barW/2, padT + innerH + 14);
      }

      if(options.title){
        ctx.fillStyle = "rgba(0,255,156,.9)";
        ctx.font = "11px Segoe UI, system-ui, sans-serif";
        ctx.textAlign = "left";
        ctx.fillText(options.title, 10, 12);
      }
    }

    /* =========================
       NIVEL (incluye CORE PRs)
    ========================= */
    function renderNivel(){
      const box = document.getElementById("nivelBox");
      const kpiGrid = document.getElementById("kpiGrid");
      const prBox = document.getElementById("prBox");
      const topBox = document.getElementById("topBox");
      const topChart = document.getElementById("topChart");

      const corePrBox = document.getElementById("corePrBox");
      const coreWeeklyChart = document.getElementById("coreWeeklyChart");

      if(!box || !kpiGrid || !prBox || !topBox || !topChart || !corePrBox || !coreWeeklyChart) return;

      const log = readLog();
      const sesiones = new Set(log.map(x=>x.date)).size;
      const series = log.length;
      const lvl = Math.min(99, Math.floor(series / 25) + 1);

      const s = summarize(log);

      box.textContent =
        `Nivel: ${lvl}\n` +
        `Sesiones (fase): ${sesiones}\n` +
        `Series totales (fase): ${series}\n\n` +
        `Fase: ${getActivePhase().name}\n` +
        `Objetivo: constancia + progresi√≥n sin dolor lumbar.`;

      kpiGrid.innerHTML = `
        <div class="kpi"><div class="k">Series (7 d√≠as)</div><div class="v">${s.series7}</div></div>
        <div class="kpi"><div class="k">Series (28 d√≠as)</div><div class="v">${s.series28}</div></div>
        <div class="kpi"><div class="k">Volumen (7 d√≠as)</div><div class="v">${fmtKg(s.vol7)}<span class="muted"> u</span></div></div>
        <div class="kpi"><div class="k">Volumen (28 d√≠as)</div><div class="v">${fmtKg(s.vol28)}<span class="muted"> u</span></div></div>
      `;

      if(s.prs.length === 0){
        prBox.innerHTML = `<div class="log-meta">A√∫n no hay PRs (solo reps con peso).</div>`;
      }else{
        prBox.innerHTML = `
          <table class="table">
            <thead><tr><th>Ejercicio</th><th>e1RM</th><th>Mejor serie</th></tr></thead>
            <tbody>
              ${s.prs.map(p => `
                <tr>
                  <td>${p.ex}</td>
                  <td><span class="pill">${fmtKg(p.e1rm)} kg</span></td>
                  <td class="muted">${p.w}√ó${p.r} (${p.date || ""})</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
      }

      if(s.top28.length === 0){
        topBox.innerHTML = `<div class="log-meta">Sin datos en √∫ltimos 28 d√≠as.</div>`;
        drawBarChart(topChart, ["‚Äî"], [0], { title:"Top 28d (volumen)" });
      }else{
        const labels = s.top28.map(x=> x.ex.length>8 ? x.ex.slice(0,8)+"‚Ä¶" : x.ex);
        const vals = s.top28.map(x=> x.vol || 0);
        drawBarChart(topChart, labels, vals, { title:"Top 28d (volumen)" });

        topBox.innerHTML = `
          <table class="table">
            <thead><tr><th>Ejercicio</th><th>Series</th><th>Volumen</th></tr></thead>
            <tbody>
              ${s.top28.map(x => `
                <tr>
                  <td>${x.ex}</td>
                  <td><span class="pill">${x.sets}</span></td>
                  <td class="muted">${fmtKg(x.vol)} u</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
      }

      /* ===== CORE PRs + progreso semanal ===== */
      const coreLog = log.filter(it => isCore(it));
      if(coreLog.length === 0){
        corePrBox.innerHTML = `<div class="log-meta">A√∫n no hay registros de CORE.</div>`;
        drawBarChart(coreWeeklyChart, ["‚Äî"], [0], { title:"CORE semanal (seg)" });
        return;
      }

      // PRs por ejercicio: mejor tiempo (seg) y mejor tiempo*lastre (seg*kg)
      const coreMap = new Map(); // ex -> { bestSec, bestWeighted, bestWeightedSec, bestKg }
      for(const it of coreLog){
        const ex = (it.ejercicio || "CORE").trim();
        const sec = toIntSafe(it.seconds || it.reps, 0);
        const kg = toNum(it.peso);
        const hasKg = Number.isFinite(kg) && kg > 0;
        const weighted = hasKg ? (sec * kg) : 0;

        const cur = coreMap.get(ex) || {
          bestSec: 0,
          bestWeighted: 0,
          bestWeightedSec: 0,
          bestKg: 0
        };

        if(sec > cur.bestSec) cur.bestSec = sec;

        if(hasKg && weighted > cur.bestWeighted){
          cur.bestWeighted = weighted;
          cur.bestWeightedSec = sec;
          cur.bestKg = kg;
        }

        coreMap.set(ex, cur);
      }

      const coreRows = [...coreMap.entries()]
        .map(([ex,v]) => ({ ex, ...v }))
        .sort((a,b)=> (b.bestSec - a.bestSec))
        .slice(0, 10);

      corePrBox.innerHTML = `
        <table class="table">
          <thead><tr><th>Ejercicio</th><th>Mejor tiempo</th><th>Mejor con lastre</th></tr></thead>
          <tbody>
            ${coreRows.map(r => `
              <tr>
                <td>${r.ex}</td>
                <td><span class="pill">${fmtTime(r.bestSec)}</span></td>
                <td class="muted">${
                  r.bestWeighted > 0
                    ? `${fmtTime(r.bestWeightedSec)} ¬∑ ${r.bestKg}kg`
                    : "‚Äî"
                }</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      // Progreso semanal (8 semanas): sumatorio de segundos CORE por semana
      const wmap = new Map(); // wk -> secondsTotal
      for(const it of coreLog){
        if(!it.date) continue;
        const wk = weekKeyFromISODate(it.date);
        const sec = toIntSafe(it.seconds || it.reps, 0);
        wmap.set(wk, (wmap.get(wk) || 0) + Math.max(0, sec));
      }
      const wkeys = [...wmap.keys()].sort().slice(-8);
      const labelsW = wkeys.map(k => k.slice(5));
      const valsW = wkeys.map(k => wmap.get(k));
      drawBarChart(coreWeeklyChart, labelsW.length ? labelsW : ["‚Äî"], valsW.length ? valsW : [0], { title:"CORE semanal (seg)" });
    }

    /* =========================
       STATS PRO
    ========================= */
    function renderStats(){
      const log = readLog();
      const meta = document.getElementById("statsMeta");
      const kpis = document.getElementById("statsKpis");
      const prioBox = document.getElementById("prioBox");
      const weeklyBox = document.getElementById("weeklyBox");
      const prioChart = document.getElementById("prioChart");
      const weeklyTonChart = document.getElementById("weeklyTonChart");
      const weeklySetsChart = document.getElementById("weeklySetsChart");
      if(!meta || !kpis || !prioBox || !weeklyBox || !prioChart || !weeklyTonChart || !weeklySetsChart) return;

      meta.textContent = `Fase: ${getActivePhase().name} ¬∑ Registros: ${log.length}`;

      const dates = log.map(x=>x.date).filter(Boolean);
      const uniqueDates = [...new Set(dates)];
      const lastDate = uniqueDates.sort().slice(-1)[0] || null;

      let daysSince = "-";
      if(lastDate){
        const a = new Date(lastDate + "T00:00:00");
        const b = new Date(todayISO() + "T00:00:00");
        daysSince = Math.round((b-a)/(24*60*60*1000));
      }

      const series7 = log.filter(x=> withinLastDays(x.ts||0,7)).length;
      const series28 = log.filter(x=> withinLastDays(x.ts||0,28)).length;

      const ses7 = new Set(log.filter(x=> withinLastDays(x.ts||0,7)).map(x=>x.date)).size;
      const ses28 = new Set(log.filter(x=> withinLastDays(x.ts||0,28)).map(x=>x.date)).size;

      kpis.innerHTML = `
        <div class="kpi"><div class="k">D√≠as desde √∫ltimo</div><div class="v">${daysSince}</div></div>
        <div class="kpi"><div class="k">Sesiones (7 d√≠as)</div><div class="v">${ses7}</div></div>
        <div class="kpi"><div class="k">Sesiones (28 d√≠as)</div><div class="v">${ses28}</div></div>
        <div class="kpi"><div class="k">Series (28 d√≠as)</div><div class="v">${series28}</div></div>
      `;

      const pr = {
        gemelos:{ sets:0, vol:0 },
        antebrazos:{ sets:0, vol:0 },
        cuello:{ sets:0, vol:0 }
      };

      log.forEach(s=>{
        if(!withinLastDays(s.ts||0,28)) return;
        const k = classifyPriority(s.ejercicio);
        if(!k) return;
        pr[k].sets += 1;
        pr[k].vol += seriesVolume(s).vol;
      });

      const prLabels = ["Gemelos","Antebrazos","Cuello"];
      const prVals = [pr.gemelos.sets, pr.antebrazos.sets, pr.cuello.sets];
      drawBarChart(prioChart, prLabels, prVals, { title:"Prioridades 28d (series)" });

      prioBox.innerHTML = `
        <table class="table">
          <thead><tr><th>Grupo</th><th>Series</th><th>Volumen</th></tr></thead>
          <tbody>
            <tr><td>Gemelos</td><td><span class="pill">${pr.gemelos.sets}</span></td><td class="muted">${fmtKg(pr.gemelos.vol)} u</td></tr>
            <tr><td>Antebrazos</td><td><span class="pill">${pr.antebrazos.sets}</span></td><td class="muted">${fmtKg(pr.antebrazos.vol)} u</td></tr>
            <tr><td>Cuello</td><td><span class="pill">${pr.cuello.sets}</span></td><td class="muted">${fmtKg(pr.cuello.vol)} u</td></tr>
          </tbody>
        </table>
      `;

      const map = new Map(); // weekKey -> {sets, vol}
      log.forEach(s=>{
        if(!s.date) return;
        const wk = weekKeyFromISODate(s.date);
        const cur = map.get(wk) || { sets:0, vol:0 };
        cur.sets += 1;
        cur.vol += seriesVolume(s).vol;
        map.set(wk, cur);
      });

      const keys = [...map.keys()].sort().slice(-8);
      if(keys.length === 0){
        weeklyBox.innerHTML = `<div class="log-meta">Sin datos suficientes a√∫n.</div>`;
        drawBarChart(weeklyTonChart, ["‚Äî"], [0], { title:"Volumen semanal" });
        drawBarChart(weeklySetsChart, ["‚Äî"], [0], { title:"Series semanales" });
      }else{
        const vols = keys.map(k => map.get(k).vol);
        const sets = keys.map(k => map.get(k).sets);
        const short = keys.map(k => k.slice(5));

        drawBarChart(weeklyTonChart, short, vols, { title:"Volumen semanal (8)" });
        drawBarChart(weeklySetsChart, short, sets, { title:"Series semanales (8)" });

        weeklyBox.innerHTML = `
          <table class="table">
            <thead><tr><th>Semana</th><th>Series</th><th>Volumen</th></tr></thead>
            <tbody>
              ${keys.map(k=>{
                const v = map.get(k);
                return `<tr><td>${k}</td><td><span class="pill">${v.sets}</span></td><td class="muted">${fmtKg(v.vol)} u</td></tr>`;
              }).join("")}
            </tbody>
          </table>
        `;
      }
    }

    /* =========================
       CALENDARIO
    ========================= */
    let CAL_ANCHOR = startOfWeekISO(new Date());

    function buildSessionsByDate(){
      const log = readLog();
      const map = new Map();
      for(const s of log){
        if(!s.date) continue;
        const cur = map.get(s.date) || { count:0, dayKey: s.day || "" };
        cur.count += 1;
        if(!cur.dayKey && s.day) cur.dayKey = s.day;
        map.set(s.date, cur);
      }
      return map;
    }

    function renderCalendar(){
      const meta = document.getElementById("calMeta");
      const grid = document.getElementById("weekGrid");
      const last4 = document.getElementById("last4Box");
      if(!meta || !grid || !last4) return;

      const map = buildSessionsByDate();
      meta.textContent = `Fase: ${getActivePhase().name} ¬∑ Semana desde ${fmtShort(iso(CAL_ANCHOR))}`;

      const today = todayISO();
      const days = Array.from({length:7}, (_,i)=> iso(addDays(CAL_ANCHOR, i)));
      const labels = ["L","M","X","J","V","S","D"];

      grid.innerHTML = days.map((d,i)=>{
        const has = map.get(d);
        const cls = ["day", has ? "done" : "", d === today ? "today" : ""].join(" ");
        const info = has ? `${has.count} series` : "‚Äî";
        const dk = has?.dayKey ? `<div class="chip">${has.dayKey}</div>` : "";
        return `
          <div class="${cls}">
            <div class="d">${labels[i]}</div>
            <div class="n">${fmtShort(d)}</div>
            <div class="m">${info}</div>
            ${dk}
          </div>
        `;
      }).join("");

      const start = addDays(CAL_ANCHOR, -7*3);
      const weeks = Array.from({length:4}, (_,w)=> addDays(start, w*7));
      last4.innerHTML = weeks.map(wStart=>{
        const wDays = Array.from({length:7}, (_,i)=> iso(addDays(wStart, i)));
        const line = wDays.map(d=>{
          const has = map.get(d);
          const mark = has ? "‚óè" : "¬∑";
          return `<span title="${d}">${mark}</span>`;
        }).join(" ");
        return `
          <div class="log-card">
            <div style="font-weight:800;">Semana ${fmtShort(iso(wStart))}</div>
            <div class="log-meta" style="margin-top:6px;">${line}</div>
          </div>
        `;
      }).join("");
    }

    function calPrevWeek(){ CAL_ANCHOR = addDays(CAL_ANCHOR, -7); renderCalendar(); }
    function calNextWeek(){ CAL_ANCHOR = addDays(CAL_ANCHOR, +7); renderCalendar(); }
    function calThisWeek(){ CAL_ANCHOR = startOfWeekISO(new Date()); renderCalendar(); }

    /* =========================
       RECORDATORIO
    ========================= */
    function renderReminder(){
      const banner = document.getElementById("reminderBanner");
      const text = document.getElementById("reminderText");
      if(!banner || !text) return;

      const log = readLog();
      const w = workoutToday();

      const dates = [...new Set(log.map(x=>x.date).filter(Boolean))].sort();
      const last = dates[dates.length-1] || null;

      let daysSince = 0;
      if(last){
        const a = new Date(last + "T00:00:00");
        const b = new Date(todayISO() + "T00:00:00");
        daysSince = Math.round((b-a)/(24*60*60*1000));
      }

      const msg =
        `Fase: "${getActivePhase().name}". ` +
        (last ? `√öltimo entreno: ${last} (hace ${daysSince} d√≠a(s)). ` : `Sin registros a√∫n. `) +
        `Hoy toca: ${w.key} ¬∑ ${w.name}.`;

      banner.style.display = "block";
      text.textContent = msg;
    }

    /* =========================
       MISI√ìN
    ========================= */
    function iniciarMision(){
      const w = workoutToday();
      localStorage.setItem(LS_MISSION, JSON.stringify({
        date:w.date, day:w.key, dayName:w.name, objetivo:"Fuerza magra", phaseId:getActivePhaseId()
      }));
      showToast("üéØ Misi√≥n iniciada");
      renderReminder();
    }
    function resetearMision(){
      localStorage.removeItem(LS_MISSION);
      showToast("‚úÖ Misi√≥n reseteada");
    }

    /* =========================
       BACKUP / RESTORE
    ========================= */
    function exportarBackup(){
      const payload = {
        schema: "entreno-backup-v1",
        exportedAt: new Date().toISOString(),
        appVersion: APP_VERSION,
        cacheVersion: CACHE_VERSION,
        data: {
          phases: readPhases(),
          activePhaseId: getActivePhaseId(),
          logAll: readLogAll(),
          dayOverride: localStorage.getItem(LS_DAY_OVERRIDE) || null,
          mission: localStorage.getItem(LS_MISSION) || null
        }
      };

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type:"application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `entreno_backup_${todayISO()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("‚úÖ Backup descargado");
    }

    function clickImport(){
      const inp = document.getElementById("importFile");
      if(!inp) return;
      inp.value = "";
      inp.click();
    }

    async function importBackupFile(file){
      const txt = await file.text();
      let obj = null;
      try{ obj = JSON.parse(txt); }catch(e){
        showToast("‚ö†Ô∏è JSON inv√°lido");
        return;
      }
      if(!obj || obj.schema !== "entreno-backup-v1" || !obj.data){
        showToast("‚ö†Ô∏è Backup no reconocido");
        return;
      }
      if(!confirm("¬øImportar backup y SOBRESCRIBIR tus datos actuales?")) return;

      const d = obj.data;
      if(Array.isArray(d.phases) && d.phases.length) writePhases(d.phases);
      if(d.activePhaseId) setActivePhase(d.activePhaseId);
      if(Array.isArray(d.logAll)) writeLogAll(d.logAll);

      if(typeof d.dayOverride === "string") localStorage.setItem(LS_DAY_OVERRIDE, d.dayOverride);
      else localStorage.removeItem(LS_DAY_OVERRIDE);

      if(typeof d.mission === "string") localStorage.setItem(LS_MISSION, d.mission);
      else localStorage.removeItem(LS_MISSION);

      showToast("‚úÖ Backup importado");
      renderPhasesUI();
      renderWorkoutToday();
      renderLog();
      renderNivel();
      renderStats();
      renderCalendar();
      refreshPwaStatus();
      renderReminder();
    }

    /* =========================
       PWA
    ========================= */
    async function refreshPwaStatus(){
      const el = document.getElementById("pwaStatus");
      if(!el) return;

      if(!("serviceWorker" in navigator)){
        el.textContent = "Estado: Service Worker NO disponible.";
        return;
      }

      const reg = await navigator.serviceWorker.getRegistration();
      if(!reg){
        el.textContent = "Estado: SW NO registrado.";
        return;
      }

      const state = reg.active ? "ACTIVO" : (reg.installing ? "INSTALANDO" : "REGISTRADO");
      el.textContent = `Estado: SW ${state} ¬∑ Cache: ${CACHE_VERSION} ¬∑ App: ${APP_VERSION}`;
    }

    async function verVersion(){
      await refreshPwaStatus();
      showToast(`‚ÑπÔ∏è ${APP_VERSION} ¬∑ cache ${CACHE_VERSION}`);
    }

    async function actualizarApp(){
      if(!("serviceWorker" in navigator)){ showToast("‚ö†Ô∏è No hay Service Worker"); return; }
      const reg = await navigator.serviceWorker.getRegistration();
      if(!reg){ showToast("‚ö†Ô∏è SW no registrado."); return; }

      try{
        await reg.update();
        if(reg.waiting){
          reg.waiting.postMessage({ type: "SKIP_WAITING" });
          showToast("üîÑ Actualizando‚Ä¶");
        }else{
          showToast("üîÑ Buscando actualizaci√≥n‚Ä¶");
        }

        navigator.serviceWorker.addEventListener("controllerchange", () => {
          window.location.reload();
        }, { once:true });

        setTimeout(()=> window.location.reload(), 1200);
      }catch(e){
        console.log(e);
        showToast("‚ö†Ô∏è No se pudo actualizar");
      }
    }

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try{
          await navigator.serviceWorker.register("./sw.js");
          refreshPwaStatus();
        }catch(e){
          console.log("SW error:", e);
        }
      });
    }

    /* =========================
       INIT
    ========================= */
    document.addEventListener("DOMContentLoaded", ()=>{
      const phases = readPhases();
      writePhases(phases);
      setActivePhase(getActivePhaseId());

      migrateLogIfNeeded();
      renderCoreTemplates();   // NUEVO
      bindModal();

      const inp = document.getElementById("importFile");
      if(inp){
        inp.addEventListener("change", async (e)=>{
          const f = e.target.files && e.target.files[0];
          if(f) await importBackupFile(f);
        });
      }

      const s = document.getElementById("logSearch");
      if(s){
        s.addEventListener("input", ()=> renderLog());
      }

      renderPhasesUI();
      renderWorkoutToday();
      renderLog();
      renderNivel();
      renderStats();
      renderCalendar();
      refreshPwaStatus();
      renderReminder();

      window.addEventListener("resize", ()=>{
        if(screens.nivel.classList.contains("active")) renderNivel();
        if(screens.stats.classList.contains("active")) renderStats();
      });
    });
  </script>
</body>
</html>
