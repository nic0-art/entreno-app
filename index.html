<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entreno App</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icon-192.png">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="theme-color" content="#00ff9c">

  <style>
    *{ box-sizing:border-box; font-family:'Segoe UI', system-ui, sans-serif; }
    body{ margin:0; background:#050a08; color:#d7ffe9; }
    .app{ max-width:420px; margin:auto; min-height:100vh; display:flex; flex-direction:column; padding:14px; }

    .header{ text-align:center; margin-bottom:12px; }
    .header h1{ margin:6px 0 2px; color:#00ff9c; }
    .header p{ margin:0; font-size:13px; opacity:.75; }

    .status-box{ display:flex; justify-content:space-between; gap:6px; margin-bottom:12px; }
    .status{ flex:1; padding:6px; border-radius:10px; text-align:center; font-size:11px; border:1px solid rgba(0,255,160,.25); }
    .green{ color:#00ff9c } .yellow{ color:#ffd000 }

    .btn{
      width:100%; padding:12px; border-radius:14px;
      background:rgba(0,0,0,.4);
      border:1px solid rgba(0,255,160,.25);
      color:#d7ffe9; margin-bottom:10px; font-weight:600;
    }
    .btn-main{ background:rgba(0,255,160,.12); border:1px solid #00ff9c; }
    .btn-ghost{ background:transparent; border:1px solid rgba(0,255,160,.18); }

    .panel{
      margin-top:12px; padding:12px; border-radius:14px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(0,255,160,.2);
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .nav{
      margin-top:auto; display:flex; justify-content:space-around;
      padding:10px 0; border-top:1px solid rgba(0,255,160,.2);
      gap:4px; flex-wrap:wrap;
    }
    .nav button{ background:none; border:none; color:#aaa; font-size:12px; padding:6px 4px; }
    .nav button.active{ color:#00ff9c; font-weight:bold; }

    .log-card{
      padding:10px; border-radius:12px;
      background:rgba(0,0,0,.30);
      border:1px solid rgba(0,255,160,.15);
      margin:10px 0;
      white-space:pre-wrap;
    }
    .log-meta{ opacity:.75; font-size:12px; }

    .row{ display:flex; gap:10px; }
    .row .btn{ width:auto; flex:1; margin-bottom:0; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field span{ font-size:12px; opacity:.8; }
    .field input, .field select{
      padding:12px; border-radius:14px;
      background:rgba(0,0,0,.4);
      border:1px solid rgba(0,255,160,.25);
      color:#d7ffe9; outline:none;
    }
    .field input:focus, .field select:focus{ border-color:#00ff9c; }

    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:flex-end; justify-content:center;
      padding:14px; z-index:9999;
    }
    .modal-backdrop.show{ display:flex; }

    .modal{
      width:100%; max-width:420px; background:#050a08;
      border:1px solid rgba(0,255,160,.25);
      border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.6);
      overflow:hidden; transform:translateY(10px);
    }

    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px 10px; border-bottom:1px solid rgba(0,255,160,.15);
    }
    .modal-title{ font-weight:800; color:#00ff9c; letter-spacing:.5px; }
    .modal-close{
      background:transparent; border:1px solid rgba(0,255,160,.25);
      color:#d7ffe9; border-radius:12px; padding:6px 10px;
    }
    .modal-body{ padding:12px; }
    .modal-actions{
      display:flex; gap:10px; padding:12px;
      border-top:1px solid rgba(0,255,160,.15);
    }
    .modal-actions .btn{ flex:1; margin:0; }

    .toast{
      position:fixed; left:50%; bottom:78px; transform:translateX(-50%);
      background:rgba(0,0,0,.85);
      border:1px solid rgba(0,255,160,.25);
      color:#d7ffe9; padding:10px 14px; border-radius:14px;
      z-index:10000; display:none;
    }

    .mini-actions{ display:flex; gap:8px; margin-top:10px; }
    .mini{
      flex:1; padding:10px; border-radius:12px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(0,255,160,.18);
      color:#d7ffe9; font-weight:600;
    }
    .mini.danger{ border-color:rgba(255,80,80,.6); }
    .mini.ok{ border-color:rgba(0,255,160,.35); }

    .kpi-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .kpi{
      padding:10px; border-radius:12px;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(0,255,160,.12);
    }
    .kpi .k{ font-size:12px; opacity:.8; }
    .kpi .v{ font-size:18px; font-weight:800; margin-top:4px; color:#00ff9c; }

    .table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; }
    .table th, .table td{
      border-bottom:1px solid rgba(0,255,160,.12);
      padding:8px 6px;
      text-align:left;
      vertical-align:top;
    }
    .table th{ color:#00ff9c; font-weight:800; }
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(0,255,160,.2);
      background:rgba(0,255,160,.08);
      font-size:11px; opacity:.95;
    }
    .muted{ opacity:.75; }

    .banner{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,255,160,.18);
      background:rgba(0,255,160,.06);
    }
    .banner .t{ color:#00ff9c; font-weight:800; margin-bottom:4px; }
    .banner .s{ font-size:12px; opacity:.85; line-height:1.3; }

    #installBtnMission, #installBtnSettings { display:none; }

    .week-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      margin-top:10px;
    }
    .day{
      padding:10px 6px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(0,255,160,.12);
      text-align:center;
      min-height:64px;
    }
    .day .d{ font-weight:800; color:#00ff9c; font-size:12px; }
    .day .n{ font-size:12px; margin-top:6px; }
    .day .m{ font-size:11px; opacity:.75; margin-top:4px; }
    .day.done{ border-color: rgba(0,255,160,.35); background: rgba(0,255,160,.08); }
    .day.today{ outline:2px solid rgba(255,208,0,.55); }
    .chip{
      display:inline-block; margin-top:6px;
      font-size:10px; padding:3px 6px;
      border-radius:999px;
      border:1px solid rgba(0,255,160,.22);
      background:rgba(0,255,160,.08);
    }

    .fav-row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .fav{
      padding:8px 10px; border-radius:999px;
      background:rgba(0,255,160,.08);
      border:1px solid rgba(0,255,160,.18);
      color:#d7ffe9;
      font-size:12px;
    }

    .timer{
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(0,255,160,.18);
      background:rgba(0,0,0,.25);
      display:none;
    }
    .timer .t{ font-weight:800; color:#00ff9c; }
    .timer .s{ margin-top:6px; font-size:22px; font-weight:900; }
    .timer .row{ margin-top:10px; }

    canvas{
      width:100%;
      height:180px;
      border-radius:12px;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(0,255,160,.12);
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <h1>Entreno App</h1>
      <p>INTERFAZ TÁCTICA · MODO OPERATIVO</p>
    </div>

    <div class="status-box">
      <div class="status green">● STATUS: OK</div>
      <div class="status yellow">● OBJETIVO: FUERZA MAGRA</div>
      <div class="status green">● OFFLINE: READY</div>
    </div>

    <!-- MISIÓN -->
    <div id="screen-mision" class="screen active">
      <button class="btn btn-main" onclick="iniciarMision()">INICIAR MISIÓN</button>
      <button class="btn" onclick="abrirEntreno()">ABRIR ENTRENAMIENTO HOY</button>
      <button class="btn" onclick="registrarSerie()">REGISTRAR SERIE</button>

      <button id="installBtnMission" class="btn btn-main" onclick="instalarApp()">INSTALAR APP</button>

      <div class="banner" id="reminderBanner" style="display:none;">
        <div class="t">RECORDATORIO</div>
        <div class="s" id="reminderText"></div>
      </div>

      <div class="panel">
        <h3>ÓRDENES DEL DÍA</h3>
        <p>Antebrazo · Gemelo · Cuello (prioridad)</p>
        <div class="log-meta" id="phaseHint"></div>
      </div>
    </div>

    <!-- ENTRENO -->
    <div id="screen-entreno" class="screen">
      <div class="panel">
        <h3>ENTRENO DE HOY</h3>
        <div id="workoutBox" class="log-card"></div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">CALENDARIO (MANUAL)</h3>
          <p class="log-meta" style="margin:0 0 10px;">
            Si hoy no toca el día correcto, selecciónalo aquí (solo afecta a HOY).
          </p>

          <label class="field">
            <span>Día de rutina para hoy</span>
            <select id="dayOverrideSelect">
              <option value="">Automático (por día semana)</option>
              <option value="D1">D1 · Empuje + Gemelo</option>
              <option value="D2">D2 · Tirón + Antebrazo</option>
              <option value="D3">D3 · Pierna sin carga axial</option>
              <option value="D4">D4 · Full suave + Cuello</option>
            </select>
          </label>

          <div class="row" style="margin-bottom:10px;">
            <button class="btn btn-main" onclick="guardarOverrideHoy()">Guardar</button>
            <button class="btn" onclick="borrarOverrideHoy()">Quitar</button>
          </div>

          <div class="log-meta" id="overrideHint"></div>
        </div>

        <label class="field" style="margin-top:10px;">
          <span>Ejercicio a registrar</span>
          <input id="quickExercise" type="text" placeholder="Ej: Prensa inclinada / Plancha / Gemelo…" />
        </label>

        <!-- NUEVO: Principal del día + plantillas -->
        <div class="row" style="margin-top:2px; margin-bottom:10px;">
          <button class="btn btn-main" onclick="ponerPrincipalDelDia()">Principal del día</button>
          <button class="btn" onclick="abrirPlantillas()">Plantillas</button>
        </div>

        <div id="tplBox" class="panel" style="display:none; margin-top:0;">
          <h3 style="margin:0 0 8px;">PLANTILLAS RÁPIDAS</h3>
          <div class="row" style="margin-bottom:10px;">
            <button class="btn" onclick="setTemplate('D1')">D1</button>
            <button class="btn" onclick="setTemplate('D2')">D2</button>
          </div>
          <div class="row">
            <button class="btn" onclick="setTemplate('D3')">D3</button>
            <button class="btn" onclick="setTemplate('D4')">D4</button>
          </div>
          <div class="log-meta" style="margin-top:10px;">Esto solo rellena el ejercicio rápido. No guarda nada aún.</div>
        </div>

        <div class="fav-row" id="favRow"></div>

        <button class="btn btn-main" onclick="registrarSerieDesdeEntreno()">REGISTRAR SERIE (ENTRENO)</button>
        <button class="btn" onclick="repetirUltimaSerieMasUno()">REPETIR ÚLTIMA SERIE (+1)</button>
        <button class="btn btn-ghost" onclick="registrarSerie()">REGISTRAR SERIE (VACÍO)</button>

        <div id="restTimer" class="timer">
          <div class="t">DESCANSO</div>
          <div class="s" id="restTime">01:30</div>
          <div class="row">
            <button class="btn btn-main" onclick="timerStart()">▶ Start</button>
            <button class="btn" onclick="timerStop()">⏸ Stop</button>
          </div>
          <div class="row">
            <button class="btn" onclick="timerPlus(30)">+30s</button>
            <button class="btn" onclick="timerMinus(30)">-30s</button>
          </div>
        </div>
      </div>
    </div>

    <!-- LOG -->
    <div id="screen-log" class="screen">
      <div class="panel">
        <h3>HISTORIAL DE SERIES</h3>

        <!-- NUEVO: buscador -->
        <label class="field" style="margin-top:10px;">
          <span>Buscar en historial (ejercicio / día / fecha)</span>
          <input id="logSearch" type="text" placeholder="Ej: plancha / 2026-02-07 / D3 / gemelo..." />
        </label>
        <div class="row" style="margin-top:-4px; margin-bottom:10px;">
          <button class="btn btn-main" onclick="aplicarBusquedaLog()">Buscar</button>
          <button class="btn" onclick="limpiarBusquedaLog()">Limpiar</button>
        </div>

        <p id="logEmptyHint" class="log-meta">Sin registros aún. Pulsa “REGISTRAR SERIE”.</p>

        <div class="row" style="margin:10px 0;">
          <button class="btn" style="border-color: rgba(255,80,80,.6);" onclick="borrarHistorial()">Borrar historial (fase)</button>
          <button class="btn" onclick="exportarCSV()">Exportar CSV</button>
        </div>

        <div id="logList"></div>
      </div>
    </div>

    <!-- NIVEL -->
    <div id="screen-nivel" class="screen">
      <div class="panel">
        <h3>NIVEL + ESTADÍSTICAS</h3>
        <div id="nivelBox" class="log-card"></div>

        <div class="kpi-grid" id="kpiGrid"></div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">PRs e1RM (estimado)</h3>
          <div class="log-meta">Fórmula e1RM: <span class="pill">Epley</span> (peso × (1 + reps/30))</div>
          <div id="prBox"></div>
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Top ejercicios (últimos 28 días)</h3>
          <div class="log-meta">Series y tonelaje (peso×reps). Si no pones peso, no suma tonelaje.</div>
          <div id="topBox"></div>
        </div>
      </div>
    </div>

    <!-- STATS -->
    <div id="screen-stats" class="screen">
      <div class="panel">
        <h3>STATS PRO</h3>
        <div class="log-meta" id="statsMeta"></div>

        <div class="kpi-grid" id="statsKpis"></div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Prioridades (últimos 28 días)</h3>
          <div class="log-meta">Series y tonelaje estimado (si hay peso). Clasificación por nombre del ejercicio.</div>
          <div id="prioBox"></div>
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Volumen semanal (últimas 8 semanas)</h3>
          <div class="log-meta">Tonelaje = peso×reps. Si faltan pesos, solo cuenta series.</div>
          <div id="weeklyBox"></div>
        </div>
      </div>
    </div>

    <!-- CAL -->
    <div id="screen-cal" class="screen">
      <div class="panel">
        <h3>CALENDARIO</h3>
        <div class="log-meta" id="calMeta"></div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="calPrevWeek()">◀ Semana</button>
          <button class="btn btn-main" onclick="calThisWeek()">Hoy</button>
          <button class="btn" onclick="calNextWeek()">Semana ▶</button>
        </div>

        <div class="week-grid" id="weekGrid"></div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Últimas 4 semanas</h3>
          <div class="log-meta">Marca días con entreno. Abre LOG para ver detalles.</div>
          <div id="last4Box"></div>
        </div>
      </div>
    </div>

    <!-- GRAF -->
    <div id="screen-graf" class="screen">
      <div class="panel">
        <h3>GRÁFICOS</h3>
        <div class="log-meta">Selecciona ejercicio para ver evolución (e1RM) y volumen.</div>

        <label class="field" style="margin-top:10px;">
          <span>Ejercicio</span>
          <select id="chartExercise"></select>
        </label>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Evolución e1RM (últimos 90 días)</h3>
          <canvas id="chartE1RM" width="400" height="180"></canvas>
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Volumen semanal (últimas 8 semanas)</h3>
          <canvas id="chartVOL" width="400" height="180"></canvas>
        </div>
      </div>
    </div>

    <!-- AJUSTES -->
    <div id="screen-ajustes" class="screen">
      <div class="panel">
        <h3>AJUSTES</h3>

        <button id="installBtnSettings" class="btn btn-main" onclick="instalarApp()">INSTALAR APP</button>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Fases</h3>
          <div class="log-meta">Cada serie se guarda dentro de la fase activa.</div>

          <label class="field" style="margin-top:10px;">
            <span>Fase activa</span>
            <select id="phaseSelect"></select>
          </label>

          <div class="row" style="margin-top:8px;">
            <button class="btn btn-main" onclick="setActivePhaseFromUI()">Aplicar</button>
            <button class="btn" onclick="crearFase()">Nueva fase</button>
          </div>

          <button class="btn" style="margin-top:10px; border-color: rgba(255,80,80,.6);" onclick="borrarFaseActiva()">Borrar fase activa</button>
          <div class="log-meta" style="margin-top:10px;">*No se recomienda borrar si ya tiene datos.</div>
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Favoritos (rápido)</h3>
          <div class="log-meta">Aparecen como chips en ENTREN0 para registrar sin escribir.</div>

          <label class="field" style="margin-top:10px;">
            <span>Nuevo favorito</span>
            <input id="favInput" type="text" placeholder="Ej: Gemelo de pie / Plancha / Curl muñeca…" />
          </label>

          <div class="row">
            <button class="btn btn-main" onclick="addFavoriteFromUI()">Añadir</button>
            <button class="btn" onclick="clearFavorites()">Borrar favoritos</button>
          </div>

          <div class="fav-row" id="favManageRow"></div>
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Temporizador descanso</h3>
          <div class="log-meta">Se puede activar tras guardar una serie.</div>

          <label class="field" style="margin-top:10px;">
            <span>Descanso por defecto (segundos)</span>
            <input id="restDefault" type="number" inputmode="numeric" placeholder="90" />
          </label>

          <label class="field">
            <span>Auto-iniciar al guardar</span>
            <select id="restAuto">
              <option value="1">Sí</option>
              <option value="0">No</option>
            </select>
          </label>

          <button class="btn btn-main" onclick="saveRestSettings()">Guardar</button>
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">Backup / Restaurar</h3>
          <div class="log-meta">Exporta todo (log + fases + ajustes) en un JSON.</div>

          <div class="row" style="margin-top:10px;">
            <button class="btn btn-main" onclick="exportarBackup()">Exportar backup</button>
            <button class="btn" onclick="clickImport()">Importar backup</button>
          </div>

          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>

        <div class="panel" style="margin-top:10px;">
          <h3 style="margin:0 0 8px;">PWA / Actualizaciones</h3>
          <div class="log-meta" id="pwaStatus">Estado: comprobando…</div>

          <div class="row" style="margin-top:10px;">
            <button class="btn btn-main" onclick="actualizarApp()">Actualizar app (cache)</button>
            <button class="btn" onclick="verVersion()">Ver versión</button>
          </div>

          <div class="log-meta" style="margin-top:10px;">
            Si no ves cambios, cierra la app (multitarea) y abre de nuevo.
          </div>
        </div>

        <button class="btn" style="margin-top:10px;" onclick="resetearMision()">Resetear misión</button>
      </div>
    </div>

    <!-- NAV -->
    <div class="nav">
      <button class="active" data-screen="mision">MISIÓN</button>
      <button data-screen="entreno">ENTRENO</button>
      <button data-screen="log">LOG</button>
      <button data-screen="nivel">NIVEL</button>
      <button data-screen="stats">STATS</button>
      <button data-screen="cal">CAL</button>
      <button data-screen="graf">GRAF</button>
      <button data-screen="ajustes">AJUSTES</button>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Registrar serie">
      <div class="modal-head">
        <div id="modalTitle" class="modal-title">REGISTRAR SERIE</div>
        <button class="modal-close" id="modalClose" aria-label="Cerrar">✕</button>
      </div>

      <div class="modal-body">
        <label class="field">
          <span>Ejercicio</span>
          <input id="mEjercicio" type="text" placeholder="Ej: Prensa inclinada / Plancha / Gemelo…" />
        </label>

        <label class="field">
          <span>Tipo</span>
          <select id="mTipo">
            <option value="reps">Repeticiones</option>
            <option value="time">Tiempo (core/isométrico)</option>
          </select>
        </label>

        <div class="row">
          <label class="field" style="flex:1;">
            <span>Peso (kg) (opcional)</span>
            <input id="mPeso" type="number" inputmode="decimal" placeholder="0" />
          </label>

          <label class="field" style="flex:1;" id="repsField">
            <span>Reps</span>
            <input id="mReps" type="number" inputmode="numeric" placeholder="0" />
          </label>
        </div>

        <div class="row" id="timeRow" style="display:none;">
          <label class="field" style="flex:1;">
            <span>Tiempo (mm:ss)</span>
            <input id="mTime" type="text" inputmode="numeric" placeholder="00:45" />
          </label>
          <label class="field" style="flex:1;">
            <span>Duración (seg) (opcional)</span>
            <input id="mTimeSec" type="number" inputmode="numeric" placeholder="45" />
          </label>
        </div>

        <div class="row">
          <label class="field" style="flex:1;">
            <span>Serie nº</span>
            <input id="mSerie" type="number" inputmode="numeric" placeholder="1" />
          </label>
          <label class="field" style="flex:1;">
            <span>RPE (opcional)</span>
            <input id="mRpe" type="number" inputmode="decimal" placeholder="8" step="0.5" min="0" max="10" />
          </label>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" id="modalCancel">Cancelar</button>
        <button class="btn btn-main" id="modalSave">Guardar</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="./app.js"></script>
</body>
</html>
